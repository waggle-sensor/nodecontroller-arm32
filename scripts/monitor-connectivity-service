#!/usr/bin/python3
# ANL:waggle-license
#  This file is part of the Waggle Platform.  Please see the file
#  LICENSE.waggle.txt for the legal details of the copyright and software
#  license.  For more details on the Waggle project, visit:
#           http://www.wa8.gl
# ANL:waggle-license
from pathlib import Path
import socket
import time


# using /run as some older nodes don't mount /tmp as tmpfs
# /run seems to be more consistently used this way
def reset_deadman_trigger():
    print('reset deadman trigger', flush=True)
    Path('/run/waggle_deadman_trigger').touch()


def reset_deadman_trigger_for_duration(duration):
    start = time.monotonic()

    while time.monotonic() - start < duration:
        reset_deadman_trigger()
        time.sleep(15)


def has_ssh_banner(addr):
    with socket.create_connection(addr, timeout=60.0) as s:
        return s.recv(1024).startswith(b'SSH')


def has_connectivity():
    try:
        return has_ssh_banner(('beehive', 20022))
    except Exception:
        return False


while True:
    while not has_connectivity():
        print('waiting for connection', flush=True)
        time.sleep(900)
    print('connection ok', flush=True)
    reset_deadman_trigger_for_duration(3600)
