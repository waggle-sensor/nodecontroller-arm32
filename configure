#!/bin/bash -ex

if [ "$EUID" -ne 0 ]; then
  echo "Please run as root"
  exit 1
fi

CONFIGURE_SYSTEM=0
while [[ $# -gt 0 ]]; do
  key="$1"
  case $key in
    -s)
      SERVER_HOST="$2"
      shift
      ;;
    --server-host=*)
      SERVER_HOST="${key#*=}"
      ;;
    --system)
      CONFIGURE_SYSTEM=1
      ;;
      *)
      ;;
  esac
  shift
done

if [ $CONFIGURE_SYSTEM -eq 1 ]; then
  if [ ${SERVER_HOST}x == "x" ] ; then
    echo "Error: must specify --server-host=<SERVER_HOST> when using the --system option"
    exit 2
  else
    echo "configuring system..."
    ./scripts/configure-system.sh --server-host=${SERVER_HOST}
  fi
fi

#set waggle parameters
mkdir -p /etc/waggle/

if [ ! -e /etc/waggle/node_controller_host ] ; then
  echo "10.31.81.10" > /etc/waggle/node_controller_host
fi

# copy etc tree into node
cp -a etc/. /etc/

systemctl enable \
  waggle-epoch.service \
  waggle-registration.service \
  waggle-reverse-tunnel.service \
  waggle-wagman-driver.service \
  waggle-monitor-connectivity.service \
  waggle-monitor-shutdown.service \
  waggle-wwan.service \
  waggle-status.timer \
  waggle-node-message-router.service \
  waggle-stage-messages-nc.service \
  waggle-stage-messages-ep.service

cp scripts/wvwaggle.sh /usr/bin/
chmod +x /usr/bin/wvwaggle.sh

rm -f /usr/local/bin/interface.py

for p in $(pwd)/scripts/waggle-*; do
    ln -sf $p /usr/bin/$(basename $p)
done

(
cd wagman
./configure
)

(
cd scripts
chmod 700 *
chmod 744 *-service
chmod 755 alphasense-info coresense-info coresense-ids modem-info modem_info.py
)

echo "done"
